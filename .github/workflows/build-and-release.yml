name: Build LLVM/MLIR toolchain (macOS arm64, standalone)

on:
  workflow_dispatch:
    inputs:
      llvm_ref:
        description: "llvm-project git ref to build (tag/branch/commit)"
        required: false
        default: "llvmorg-19.1.0"
      patch_set:
        description: "Optional patch set name under patches/ to apply (leave blank for none)"
        required: false
        default: ""
  push:
    branches: ["main", "ci/**"]
    tags: ["v*"]

env:
  PYTHON_VERSION: "3.12"

jobs:
  toolchain:
    name: Build LLVM/MLIR (macOS arm64)
    runs-on: macos-14

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build deps (Homebrew)
        run: |
          brew update --preinstall || true
          brew install ninja cmake || true

      - name: Clone llvm-project at ref
        env:
          LLVM_REF: ${{ github.event.inputs.llvm_ref || 'llvmorg-19.1.0' }}
        run: |
          mkdir -p toolchain && cd toolchain
          git clone https://github.com/llvm/llvm-project.git
          git -C llvm-project checkout "${LLVM_REF}"

      - name: Apply optional patches (if any)
        env:
          PATCH_SET: ${{ github.event.inputs.patch_set || '' }}
        shell: bash
        run: |
          set -euo pipefail
          ROOT="${GITHUB_WORKSPACE}"
          SRC="${GITHUB_WORKSPACE}/toolchain/llvm-project"
          # Apply common patches
          if compgen -G "${ROOT}/patches/common/*.patch" > /dev/null; then
            for p in ${ROOT}/patches/common/*.patch; do
              echo "Applying common patch: $p"
              git -C "${SRC}" apply "$p"
            done
          fi
          # Apply named patch set
          if [[ -n "${PATCH_SET}" ]] && compgen -G "${ROOT}/patches/${PATCH_SET}/*.patch" > /dev/null; then
            for p in ${ROOT}/patches/${PATCH_SET}/*.patch; do
              echo "Applying ${PATCH_SET} patch: $p"
              git -C "${SRC}" apply "$p"
            done
          fi

      - name: Configure (CMake + Ninja)
        run: |
          cmake -G Ninja -S toolchain/llvm-project/llvm -B toolchain/build \
            -DLLVM_ENABLE_PROJECTS="clang;mlir;openmp" \
            -DLLVM_TARGETS_TO_BUILD=host \
            -DLLVM_BUILD_EXAMPLES=ON \
            -DCMAKE_BUILD_TYPE=Release \
            -DLLVM_ENABLE_ASSERTIONS=ON \
            -DLLVM_INSTALL_UTILS=ON \
            -DMLIR_ENABLE_BINDINGS_PYTHON=ON \
            -DPython3_EXECUTABLE="${{ env.pythonLocation }}/bin/python3"

      - name: Build (Ninja)
        run: cmake --build toolchain/build -- -v

      - name: Package toolchain build dir
        run: |
          mkdir -p out
          tar -C toolchain/build -czf out/llvm-mlir-macos-arm64.tar.gz .
          ls -lh out/llvm-mlir-macos-arm64.tar.gz

      - name: Upload toolchain artifact
        uses: actions/upload-artifact@v4
        with:
          name: llvm-mlir-macos-arm64
          path: out/llvm-mlir-macos-arm64.tar.gz
          if-no-files-found: error

  release:
    name: Create GitHub Release with artifacts (on tag)
    needs: [toolchain]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: macos-14
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_artifacts

      - name: Show collected artifacts
        run: find release_artifacts -type f -maxdepth 2 -print

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release_artifacts/**/*

